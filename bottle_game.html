<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Bottle Collector (Phaser)</title>
  <style>
    html,body { height:100%; margin:0; background:#87CEEB; }
    #game-container { width:100%; height:100vh; overflow:hidden; }
    
    /* Banner with ფოთი text */
    #banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border-bottom: 3px solid #2e7d32;
    }
    #banner-text {
      font-family: 'Arial', sans-serif;
      font-size: 32px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      letter-spacing: 2px;
    }
    
    /* Simple mobile control buttons */
    .controls { position: fixed; left: 0; right:0; bottom: 12px; display:flex; justify-content:center; gap:12px; pointer-events:none; }
    .btn { pointer-events:auto; user-select:none; width:72px; height:72px; border-radius:12px; background:rgba(0,0,0,0.25); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:22px; }
    .btn.small { width:56px; height:56px; font-size:18px; }
    
    #info { 
      position:fixed; 
      left:12px; 
      top:80px; 
      background:rgba(255,255,255,0.9); 
      padding:8px 10px; 
      border-radius:8px; 
      font-family:sans-serif;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
  <!-- Banner -->
  <div id="banner">
    <div id="banner-text">ფოთი</div>
  </div>
  
  <div id="game-container"></div>
  <div id="info">Bottles: <span id="score">0</span>/<span id="total">0</span></div>
  
  <!-- Mobile controls -->
  <div class="controls" aria-hidden="true">
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="leftBtn" class="btn">◀</div>
      <div id="rightBtn" class="btn">▶</div>
      <div id="jumpBtn" class="btn small">▲</div>
    </div>
  </div>

<script>
class MainScene extends Phaser.Scene {
  constructor(){ super('MainScene'); }
  
  preload() {
    // No external assets — we create simple textures at runtime
  }

  create() {
    // world
    this.physics.world.setBounds(0, 0, 1200, 700);
    
    // Create nature background
    this.createNatureBackground();
    
    // create small textures
    this.makePlayerTexture();
    this.makeBottleTextures();
    this.makeTrashTexture();
    
    // platforms group (static)
    this.platforms = this.physics.add.staticGroup();
    
    // ground (grass)
    this.platforms.create(600, 680, null).setDisplaySize(1200, 40).refreshBody().setTint(0x4CAF50);
    
    // some floating platforms (wooden/brown)
    const plats = [
      [250, 540, 240, 20], [450, 430, 240, 20], [700, 480, 220, 20], 
      [900, 580, 220, 20], [200, 350, 140, 20], [520, 300, 140, 20]
    ];
    
    plats.forEach(p=>{
      const plat = this.add.rectangle(p[0], p[1], p[2], p[3], 0x8d6e63);
      this.physics.add.existing(plat, true);
      this.platforms.add(plat);
    });
    
    // player
    this.player = this.physics.add.sprite(80, 600, 'player');
    this.player.setCollideWorldBounds(true);
    this.player.setBounce(0);
    this.player.body.setSize(36, 48).setOffset(2, 2);
    
    // collisions
    this.physics.add.collider(this.player, this.platforms);
    
    // bottles (collectibles)
    this.bottles = this.physics.add.group({ allowGravity: false });
    const bottlePositions = [
      [300, 500, 'plastic'], [500, 380, 'glass'], [720, 440, 'plastic'], 
      [940, 540, 'glass'], [240, 260, 'plastic'], [560, 220, 'glass'], 
      [420, 380, 'plastic']
    ];
    
    bottlePositions.forEach(p=>{
      const b = this.bottles.create(p[0], p[1], p[2]);
      b.type = p[2];
      b.setSize(20, 28).setOffset(0, 0);
    });
    
    // trash can at the far right
    this.trash = this.physics.add.staticSprite(1100, 620, 'trash');
    this.trash.setSize(60, 80).setOffset(0, 0);
    
    // overlaps
    this.physics.add.overlap(this.player, this.bottles, this.collectBottle, null, this);
    this.physics.add.overlap(this.player, this.trash, this.tryFinish, null, this);
    
    // camera
    this.cameras.main.setBounds(0, 0, 1200, 700);
    this.cameras.main.startFollow(this.player, true, 0.08, 0.08);
    this.cameras.main.setBackgroundColor(0x87CEEB); // Sky blue background
    
    // controls
    this.cursors = this.input.keyboard.createCursorKeys();
    this.WASD = this.input.keyboard.addKeys('W,A,S,D');
    this.isLeft = false; 
    this.isRight = false; 
    this.isJump = false;
    this.jumpPressed = false; // Track if jump was just pressed
    this.mobileJumpJustPressed = false; // Track mobile jump button press
    
    // mobile buttons
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const jumpBtn = document.getElementById('jumpBtn');
    
    const makeDownUp = (el, onDown, onUp)=>{
      el.addEventListener('pointerdown', e=>{ e.preventDefault(); onDown(); });
      el.addEventListener('pointerup', e=>{ e.preventDefault(); onUp(); });
      el.addEventListener('pointerout', e=>{ e.preventDefault(); onUp(); });
      el.addEventListener('pointercancel', e=>{ e.preventDefault(); onUp(); });
    };
    
    makeDownUp(leftBtn, ()=>this.isLeft=true, ()=>this.isLeft=false);
    makeDownUp(rightBtn, ()=>this.isRight=true, ()=>this.isRight=false);
    makeDownUp(jumpBtn, ()=>{
      this.isJump = true;
      this.mobileJumpJustPressed = true; // Mark that jump button was just pressed
    }, ()=>{
      this.isJump = false;
    });
    
    // UI counts
    this.collected = 0;
    document.getElementById('total').textContent = this.bottles.getChildren().length;
    document.getElementById('score').textContent = this.collected;
    
    this.showedHint = false;
  }

  createNatureBackground() {
    // Create sky gradient background
    const bg = this.add.graphics();
    bg.fillGradientStyle(0x87CEEB, 0x87CEEB, 0xB0E0E6, 0xB0E0E6, 1);
    bg.fillRect(0, 0, 1200, 700);
    bg.setScrollFactor(0); // Fixed background
    
    // Add some clouds
    for (let i = 0; i < 5; i++) {
      const x = Phaser.Math.Between(100, 1100);
      const y = Phaser.Math.Between(50, 200);
      const cloud = this.add.circle(x, y, 30, 0xFFFFFF, 0.6);
      cloud.setScrollFactor(0.1);
      const cloud2 = this.add.circle(x + 25, y, 25, 0xFFFFFF, 0.6);
      cloud2.setScrollFactor(0.1);
      const cloud3 = this.add.circle(x - 25, y, 25, 0xFFFFFF, 0.6);
      cloud3.setScrollFactor(0.1);
    }
    
    // Add sun
    const sun = this.add.circle(1000, 100, 40, 0xFFEB3B, 0.8);
    sun.setScrollFactor(0);
  }

  update() {
    const onGround = this.player.body.blocked.down || this.player.body.touching.down;
    
    // horizontal movement
    let vx = 0;
    if (this.cursors.left.isDown || this.WASD.A.isDown || this.isLeft) vx = -180;
    if (this.cursors.right.isDown || this.WASD.D.isDown || this.isRight) vx = 180;
    this.player.setVelocityX(vx);
    
    // Improved jump mechanics - only jump when key is first pressed
    const jumpKeyPressed = Phaser.Input.Keyboard.JustDown(this.cursors.up) || 
                          Phaser.Input.Keyboard.JustDown(this.WASD.W) || 
                          Phaser.Input.Keyboard.JustDown(this.cursors.space) ||
                          (this.mobileJumpJustPressed && !this.jumpPressed);
    
    if (jumpKeyPressed && onGround) {
      this.player.setVelocityY(-480); // Same jump strength for all inputs
      this.jumpPressed = true;
      this.mobileJumpJustPressed = false; // Consume mobile jump press
    }
    
    // Reset jump flag when key is released
    if (!this.isJump && !this.cursors.up.isDown && !this.WASD.W.isDown && !this.cursors.space.isDown) {
      this.jumpPressed = false;
    }
    
    // Reset mobile jump flag after processing
    if (this.mobileJumpJustPressed && this.jumpPressed) {
      this.mobileJumpJustPressed = false;
    }
    
    // Allow variable jump height - release early for shorter jump
    if (!onGround && this.player.body.velocity.y < 0) {
      if (!this.cursors.up.isDown && !this.WASD.W.isDown && !this.cursors.space.isDown && !this.isJump) {
        // Reduce upward velocity if jump key is released early
        this.player.setVelocityY(this.player.body.velocity.y * 0.7);
      }
    }
    
    // small idle animation (tilt)
    if (vx < 0) this.player.setAngle(-6); 
    else if (vx > 0) this.player.setAngle(6); 
    else this.player.setAngle(0);
    
    // hint
    if (!this.showedHint && (vx !== 0 || !onGround)){
      this.showedHint = true;
    }
  }

  collectBottle(player, bottle){
    bottle.disableBody(true, true);
    this.collected += 1;
    document.getElementById('score').textContent = this.collected;
  }

  tryFinish(player, trash){
    if (this.collected === this.bottles.getChildren().length) {
      this.showWin();
    } else {
      this.showNeedAll();
    }
  }

  showWin(){
    this.scene.pause();
    const d = document.createElement('div');
    d.style = 'position:fixed;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);font-family:sans-serif;z-index:20000;';
    d.innerHTML = `<div style="background:white;padding:26px;border-radius:12px;text-align:center;max-width:90%;"><h2>Thank you!</h2><p>You recycled all bottles. Great job! ♻</p><button id=restart style="padding:10px 20px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:6px;cursor:pointer;">Play again</button></div>`;
    document.body.appendChild(d);
    document.getElementById('restart').addEventListener('click', ()=>{ d.remove(); this.scene.restart(); });
  }

  showNeedAll(){
    const txt = this.add.text(this.player.x, this.player.y - 80, 'Collect all bottles first!', { 
      font: '18px sans-serif', 
      backgroundColor: 'rgba(255,255,255,0.9)', 
      padding: {x:8, y:6} 
    });
    txt.setDepth(9999);
    this.time.delayedCall(1200, ()=>{ txt.destroy(); });
  }

  // textures
  makePlayerTexture(){
    const g = this.make.graphics({ x:0, y:0, add:false });
    g.fillStyle(0x0b67c2, 1);
    g.fillRoundedRect(0, 0, 40, 50, 6);
    g.fillStyle(0xffffff, 1);
    g.fillCircle(12, 15, 4);
    g.fillCircle(28, 15, 4);
    g.fillStyle(0x000000, 1);
    g.fillCircle(12, 15, 2);
    g.fillCircle(28, 15, 2);
    g.generateTexture('player', 40, 50);
    g.destroy();
  }

  makeBottleTextures(){
    // plastic (green)
    const g1 = this.make.graphics({ add:false });
    g1.fillStyle(0x009900, 1);
    g1.fillRect(0, 6, 20, 28);
    g1.fillRect(8, 0, 4, 6);
    g1.fillStyle(0x8B4513, 1);
    g1.fillRect(7, -2, 6, 3);
    g1.generateTexture('plastic', 20, 34);
    g1.destroy();
    
    // glass (clear-ish)
    const g2 = this.make.graphics({ add:false });
    g2.fillStyle(0xc8dfff, 1);
    g2.fillRect(0, 6, 20, 28);
    g2.fillRect(8, 0, 4, 6);
    g2.fillStyle(0x8B4513, 1);
    g2.fillRect(7, -2, 6, 3);
    g2.generateTexture('glass', 20, 34);
    g2.destroy();
  }

  makeTrashTexture(){
    const g = this.make.graphics({ add:false });
    g.fillStyle(0x808080, 1);
    g.fillRect(0, 0, 60, 80);
    g.fillStyle(0x000000, 1);
    g.fillRect(-5, 0, 70, 10);
    // recycle symbol simple
    g.fillStyle(0x00aa00, 1);
    g.fillTriangle(20, 28, 30, 20, 40, 28);
    g.fillTriangle(28, 34, 34, 26, 40, 34);
    g.generateTexture('trash', 60, 80);
    g.destroy();
  }
}

const config = {
  type: Phaser.AUTO,
  parent: 'game-container',
  width: 800,
  height: 600,
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH,
  },
  physics: {
    default: 'arcade',
    arcade: { 
      gravity: { y: 900 }, 
      debug: false 
    }
  },
  scene: [MainScene]
};

const game = new Phaser.Game(config);

// Prevent scrolling on mobile when touching controls
['touchstart','touchmove','touchend'].forEach(ev=>
  document.addEventListener(ev, e=>{ 
    if (e.target.closest('.btn')) e.preventDefault(); 
  }, { passive:false })
);
</script>
</body>
</html>

